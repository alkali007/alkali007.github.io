"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1211],{49733:function(e,t,r){r.d(t,{bs:function(){return u}});var n=r(31191),s=r(90215),o=r(49126),i=function(e){function t(t){var r=t.data,n=t.status,s=e.call(this)||this;return s.name="RequestError",s.data=r,s.status=n,s}return(0,n.__extends)(t,e),t}(Error),a=function(){function e(e){this.logger=e}return e.prototype.request=function(e){return(0,n.__awaiter)(this,void 0,void 0,(function(){var t,r,s,a,c;return(0,n.__generator)(this,(function(n){switch(n.label){case 0:if(t=new URL(e.url),e.params)for(r in e.params)t.searchParams.append(r,String(e.params[r]));n.label=1;case 1:return n.trys.push([1,3,,4]),[4,fetch(t.href,{body:e.data,headers:e.headers,method:e.method})];case 2:return s=n.sent(),[3,4];case 3:throw h=a=n.sent(),(0,o.Kn)(h)&&"Failed to fetch"===h.message||this.logger.warn("Request failed",a),new i({status:-1});case 4:return[4,this.tryParsingBody(s)];case 5:if(c=n.sent(),s.status>=200&&s.status<300)return[2,{data:c}];throw new i({data:c,status:s.status})}var h}))}))},e.prototype.tryParsingBody=function(e){return(0,n.__awaiter)(this,void 0,void 0,(function(){var t,r;return(0,n.__generator)(this,(function(n){switch(n.label){case 0:if(t=e.headers.get("content-type"),r=e.headers.get("content-length"),!(null==t?void 0:t.includes("application/json"))||"0"===r)return[3,5];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,e.json()];case 2:return[2,n.sent()];case 3:return n.sent(),this.logger.warn("Error occurred while parsing response body"),[2,null];case 4:return[3,6];case 5:return[2,null];case 6:return[2]}}))}))},e}(),c=function(){function e(e){this.logger=e}return e.prototype.getItemOrNull=function(e){try{return window.sessionStorage.getItem(e)}catch(e){return this.logger.warn("Error occurred while reading from session storage",e),null}},e.prototype.tryRemoveItem=function(e){try{return window.sessionStorage.removeItem(e),!0}catch(e){return this.logger.warn("Error occurred while removing from session storage",e),!1}},e.prototype.trySetItem=function(e,t){try{return window.sessionStorage.setItem(e,t),!0}catch(e){return this.logger.warn("Error occurred while setting in session storage",e),!1}},e}(),h="oauthState",u=function(){function e(e){var t,r,n,s;this.accessToken=null,this.accessTokenExpiresAt=null,this.refreshToken=null,this.listeners={accessTokenChange:[],logout:[]},this.serverUri=e.serverUri,this.clientId=e.clientId,this.headers=e.headers,this.logger=null!==(t=e.logger)&&void 0!==t?t:console,this.httpClient=null!==(r=e.httpClient)&&void 0!==r?r:new a(this.logger),this.sessionStorage=null!==(n=e.sessionStorage)&&void 0!==n?n:new c(this.logger),this.browser=null!==(s=e.browser)&&void 0!==s?s:{redirect:function(e){window.location.href=e}}}return Object.defineProperty(e.prototype,"loggedIn",{get:function(){return!!this.refreshToken},enumerable:!1,configurable:!0}),e.prototype.authorize=function(e){var t=e.redirectUri,r=e.scope,n=e.prompt;if(!r.includes("offline_access"))throw new Error("We need offline_access scope to get a refresh token");if(!n.includes("none")&&!n.includes("consent"))throw new Error("We need consent prompt to get a refresh token");var o=new URL("".concat(this.serverUri,"/oauth2/authorize"));o.searchParams.append("response_type","code"),o.searchParams.append("client_id",this.clientId),o.searchParams.append("redirect_uri",t),o.searchParams.append("scope",r.join(" ")),o.searchParams.append("prompt",n.join(" "));var i=(0,s.zO)(20);this.sessionStorage.trySetItem(h,i)&&o.searchParams.append("state",i),this.browser.redirect(o.href)},e.prototype.finishAuthorize=function(e,t){var r;return(0,n.__awaiter)(this,void 0,void 0,(function(){var s,o;return(0,n.__generator)(this,(function(n){switch(n.label){case 0:if(!t.code)return[3,2];if(s=this.sessionStorage.getItemOrNull(h),this.sessionStorage.tryRemoveItem(h),(null!==(r=t.state)&&void 0!==r?r:null)!==s)throw new d("State does not match");return[4,this.doHttpRequestTokenUsingAuthorizationCode(t.code,e)];case 1:return o=n.sent(),this.consumeOAuthTokenResponse(o.data),[3,3];case 2:throw t.error?new d([t.error,t.error_description].filter(Boolean).join(": ")):new d("No authorization code or error present");case 3:return[2]}}))}))},e.prototype.setRefreshToken=function(e){this.refreshToken=e},e.prototype.refreshAccessToken=function(){var e=this;return this.ongoingAccessTokenRefresh||(this.ongoingAccessTokenRefresh=this.refreshAccessTokenInternal(),this.ongoingAccessTokenRefresh.finally((function(){e.ongoingAccessTokenRefresh=void 0})).catch((function(){}))),this.ongoingAccessTokenRefresh},e.prototype.logout=function(){return(0,n.__awaiter)(this,void 0,void 0,(function(){var e;return(0,n.__generator)(this,(function(t){switch(t.label){case 0:return(e=this.refreshToken)?(this.clearTokens(),[4,this.doHttpRequestRevokeRefreshToken(e)]):[2];case 1:return t.sent(),this.emitLogout(),this.browser.redirect("".concat(this.serverUri,"/oauth2/logout?client_id=").concat(this.clientId)),[2]}}))}))},e.prototype.getValidAccessToken=function(){return(0,n.__awaiter)(this,void 0,void 0,(function(){return(0,n.__generator)(this,(function(e){if(!this.loggedIn)throw new l;return this.ongoingAccessTokenRefresh?[2,this.ongoingAccessTokenRefresh]:!this.accessToken||this.shouldRefreshAccessToken()?[2,this.refreshAccessToken()]:[2,this.accessToken]}))}))},e.prototype.getRefreshTokenForAudience=function(e){return(0,n.__awaiter)(this,void 0,void 0,(function(){var t;return(0,n.__generator)(this,(function(r){switch(r.label){case 0:if(!this.refreshToken)throw new l;return[4,this.doHttpRequestTokenUsingTokenExchange(e,this.refreshToken)];case 1:if(!(t=r.sent()).data.refresh_token)throw new Error("Refresh token is missing");return this.refreshToken=t.data.refresh_token,[2,t.data.access_token]}}))}))},e.prototype.on=function(e,t){this.listeners[e].push(t)},e.prototype.off=function(e,t){var r=this.listeners[e].indexOf(t);-1!==r&&this.listeners[e].splice(r,1)},e.prototype.invalidateRefreshTokenForTesting=function(){return(0,n.__awaiter)(this,void 0,void 0,(function(){return(0,n.__generator)(this,(function(e){switch(e.label){case 0:return this.refreshToken?[4,this.doHttpRequestRevokeRefreshToken(this.refreshToken)]:[2];case 1:return e.sent(),[2]}}))}))},e.prototype.shouldRefreshAccessToken=function(){if(!this.accessToken)return!0;if(null==this.accessTokenExpiresAt)throw new Error("Access token expiration time is missing");return!(this.accessTokenExpiresAt-Date.now()>6e4)},e.prototype.consumeOAuthTokenResponse=function(e){if(!e.refresh_token)throw new Error("Refresh token is missing");this.accessToken=e.access_token,this.accessTokenExpiresAt=Date.now()+1e3*e.expires_in,this.refreshToken=e.refresh_token,this.listeners.accessTokenChange.forEach((function(t){return t(e.access_token)}))},e.prototype.refreshAccessTokenInternal=function(){return(0,n.__awaiter)(this,void 0,void 0,(function(){var e,t;return(0,n.__generator)(this,(function(r){switch(r.label){case 0:if(!this.refreshToken)throw new l;r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.doHttpRequestTokenUsingRefreshToken(this.refreshToken)];case 2:return e=r.sent(),this.consumeOAuthTokenResponse(e.data),[2,e.data.access_token];case 3:if((t=r.sent())instanceof i&&400===t.status&&(0,o.Kn)(t.data)&&"invalid_grant"===t.data.error)throw this.clearTokens(),this.emitLogout(),new l;throw t;case 4:return[2]}}))}))},e.prototype.clearTokens=function(){this.accessToken=null,this.accessTokenExpiresAt=null,this.refreshToken=null},e.prototype.emitLogout=function(){this.listeners.logout.forEach((function(e){return e()}))},e.prototype.doHttpRequestTokenUsingAuthorizationCode=function(e,t){return(0,n.__awaiter)(this,void 0,void 0,(function(){return(0,n.__generator)(this,(function(r){switch(r.label){case 0:return[4,this.httpClient.request({data:f({client_id:this.clientId,code:e,grant_type:"authorization_code",redirect_uri:t}),headers:(0,n.__assign)({"Content-Type":"application/x-www-form-urlencoded"},this.headers),method:"post",url:"".concat(this.serverUri,"/oauth2/token")})];case 1:return[2,r.sent()]}}))}))},e.prototype.doHttpRequestTokenUsingRefreshToken=function(e){return(0,n.__awaiter)(this,void 0,void 0,(function(){return(0,n.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.httpClient.request({data:f({client_id:this.clientId,grant_type:"refresh_token",refresh_token:e}),headers:(0,n.__assign)({"Content-Type":"application/x-www-form-urlencoded"},this.headers),method:"post",url:"".concat(this.serverUri,"/oauth2/token")})];case 1:return[2,t.sent()]}}))}))},e.prototype.doHttpRequestTokenUsingTokenExchange=function(e,t){return(0,n.__awaiter)(this,void 0,void 0,(function(){return(0,n.__generator)(this,(function(r){switch(r.label){case 0:return[4,this.httpClient.request({data:f({audience:e,grant_type:"urn:ietf:params:oauth:grant-type:token-exchange",requested_token_type:"urn:ietf:params:oauth:token-type:refresh_token",subject_token:t,subject_token_type:"urn:ietf:params:oauth:token-type:refresh_token",token_exchange_version:"2"}),headers:(0,n.__assign)({"Content-Type":"application/x-www-form-urlencoded"},this.headers),method:"post",url:"".concat(this.serverUri,"/oauth2/token")})];case 1:return[2,r.sent()]}}))}))},e.prototype.doHttpRequestRevokeRefreshToken=function(e){return(0,n.__awaiter)(this,void 0,void 0,(function(){return(0,n.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.httpClient.request({data:f({client_id:this.clientId,token:e,token_type_hint:"refresh_token"}),headers:(0,n.__assign)({"Content-Type":"application/x-www-form-urlencoded"},this.headers),method:"post",url:"".concat(this.serverUri,"/oauth2/revoke")})];case 1:return t.sent(),[2]}}))}))},e}();function f(e){return Object.entries(e).map((function(e){var t=(0,n.__read)(e,2),r=t[0],s=t[1];return"".concat(encodeURIComponent(r),"=").concat(encodeURIComponent(s))})).join("&")}var l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="LoggedOutError",t}return(0,n.__extends)(t,e),t}(Error),d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="AuthorizeError",t}return(0,n.__extends)(t,e),t}(Error)}}]);
//# sourceMappingURL=lib.s.oauth.449b5c71c74a0ee6a575.bundle.js.map